# Issue: Add error handling to new command

## Overview
# Issue #004.2: Add error handling to new command

## Overview
Integrate comprehensive error handling into the PRD new command using the error recovery script and enhanced validation logic.

## Files to Modify
1. `.claude/commands/cccc/prd/new.md` (modify)

## Implementation Sketch

Add error handling integration to the existing new command:

```markdown
## Error Handling Integration

### Source Error Recovery Functions
```bash
# Source recovery and validation functions
if [[ -f ".claude/scripts/cccc/error-recovery.sh" ]]; then
    source ".claude/scripts/cccc/error-recovery.sh"
fi

if [[ -f ".claude/scripts/cccc/validate-prd.sh" ]]; then
    source ".claude/scripts/cccc/validate-prd.sh"
fi
```

### Enhanced Error Handling Wrapper
```bash
# Main PRD creation with comprehensive error handling
create_prd_with_error_handling() {
    local prd_name="$1"
    local prd_path=".cccc/prds/${prd_name}.md"
    
    # Initialize recovery for this operation
    init_recovery "prd-creation" || {
        echo "âŒ Failed to initialize recovery system"
        return 1
    }
    
    # Create backup if PRD exists
    local backup_path
    if [[ -f "$prd_path" ]]; then
        backup_path=$(create_backup "$prd_path" "prd-${prd_name}")
        local backup_result=$?
        
        if [[ $backup_result -ne 0 ]]; then
            echo "âš ï¸ Failed to create backup, continuing anyway..."
        fi
    fi
    
    # Attempt PRD creation with error trapping
    {
        # Validate inputs
        validate_prd_name "$prd_name" || return 1
        
        # Validate and create directory structure
        validate_and_create_directories || return 1
        
        # Check for existing PRD and get user confirmation
        check_existing_prd "$prd_name" || return 1
        
        # Generate PRD content
        local prd_content
        prd_content=$(generate_prd_content "$prd_name") || {
            echo "âŒ Failed to generate PRD content"
            return 1
        }
        
        # Write PRD file atomically
        echo "$prd_content" > "${prd_path}.tmp" || {
            echo "âŒ Failed to write PRD file"
            return 1
        }
        
        # Validate written file
        validate_yaml_frontmatter "${prd_path}.tmp" || {
            echo "âŒ Generated PRD has invalid frontmatter"
            rm -f "${prd_path}.tmp"
            return 1
        }
        
        # Atomic move to final location
        mv "${prd_path}.tmp" "$prd_path" || {
            echo "âŒ Failed to finalize PRD file"
            rm -f "${prd_path}.tmp"
            return 1
        }
        
        echo "ğŸ‰ PRD created successfully: $prd_path"
        return 0
        
    } || {
        # Error occurred during creation
        local error_code=$?
        echo "ğŸš¨ Error during PRD creation (code: $error_code)"
        
        # Cleanup partial files
        rm -f "${prd_path}.tmp"
        
        # Attempt recovery
        echo "ğŸ”§ Attempting recovery..."
        recover_prd_creation "$prd_name"
        
        # Validate system state
        validate_system_state
        
        echo "âŒ PRD creation failed. System state validated."
        echo "ğŸ’¡ To retry: /cccc:prd:new $prd_name"
        
        if [[ -n "$backup_path" && -f "$backup_path" ]]; then
            echo "ğŸ’¡ Backup available at: $backup_path"
        fi
        
        return $error_code
    }
}
```

### User-Friendly Error Messages
```bash
# Enhanced error reporting
report_creation_error() {
    local error_type="$1"
    local details="$2"
    
    case "$error_type" in
        "validation")
            echo "ğŸš¨ Validation Error: $details"
            echo "ğŸ’¡ Check your PRD name and try again"
            ;;
        "filesystem")
            echo "ğŸš¨ Filesystem Error: $details"
            echo "ğŸ’¡ Check permissions and available disk space"
            ;;
        "corruption")
            echo "ğŸš¨ Data Corruption: $details"
            echo "ğŸ’¡ Run recovery to clean up corrupted files"
            ;;
        *)
            echo "ğŸš¨ Unknown Error: $details"
            echo "ğŸ’¡ Check system logs for more information"
            ;;
    esac
}
```

### Recovery Guidance
```bash
# Provide recovery guidance to users
provide_recovery_guidance() {
    local prd_name="$1"
    
    echo ""
    echo "ğŸ† Recovery Options:"
    echo "  1. Retry creation: /cccc:prd:new $prd_name"
    echo "  2. Manual recovery: .claude/scripts/cccc/error-recovery.sh prd-creation $prd_name"
    echo "  3. Validate system: .claude/scripts/cccc/error-recovery.sh validate-state"
    echo "  4. Check logs: cat .cccc/recovery.log"
}
```
```

## Acceptance Criteria
- [ ] Command integrates error recovery script functionality
- [ ] Atomic file operations prevent partial/corrupted PRDs
- [ ] Comprehensive error trapping with specific error types
- [ ] User-friendly error messages with actionable guidance
- [ ] Backup creation before overwriting existing PRDs
- [ ] Recovery guidance provided on failures
- [ ] System state validation after errors
- [ ] Integration with existing command flow

## Dependencies
- Issue #003.1: Validation logic improvements must be complete
- Issue #004.1: Error recovery script must exist

## Definition of Done
- [ ] Code implemented according to implementation sketch
- [ ] All acceptance criteria met
- [ ] Error handling follows CCCC patterns and standards
- [ ] Comprehensive recovery and cleanup mechanisms
- [ ] Ready for documentation updates (Issue #005.1)\n\n---\nDepends on #38

## Comments Processing Summary
2025-08-28T11:37:34Z: Updated from platform

### Structured Updates Applied:


**jeunesse.paulien** (2025-08-28T04:42:33.476Z):
mentioned in issue #45


---
*Last updated from platform: 2025-08-28T11:37:34Z*
