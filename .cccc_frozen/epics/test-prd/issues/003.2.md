# Issue: Improve parse command validation logic

## Overview
# Issue #003.2: Improve parse command validation logic

## Overview
Enhance the PRD parse command validation logic to provide comprehensive PRD existence checking, frontmatter validation, and improved parsing error handling.

## Files to Modify
1. `.claude/commands/cccc/prd/parse.md` (modify)

## Implementation Sketch

Add enhanced validation section to the existing parse command:

```markdown
## Enhanced Parse Validation Logic

### Validate PRD Exists and Readable
```bash
# Comprehensive PRD existence and readability validation
validate_prd_for_parsing() {
    local prd_name="$1"
    local prd_path=".cccc/prds/${prd_name}.md"
    
    # Check if file exists
    if [[ ! -f "$prd_path" ]]; then
        echo "❌ PRD not found: $prd_path"
        echo "💡 Available PRDs:"
        ls -1 .cccc/prds/*.md 2>/dev/null | sed 's|.cccc/prds/||g' | sed 's|.md$||g' | sed 's/^/   • /'
        return 1
    fi
    
    # Check if file is readable
    if [[ ! -r "$prd_path" ]]; then
        echo "❌ PRD not readable: $prd_path"
        echo "💡 Check file permissions"
        return 1
    fi
    
    # Check if file has content
    if [[ ! -s "$prd_path" ]]; then
        echo "❌ PRD is empty: $prd_path"
        return 1
    fi
    
    echo "✅ PRD validated for parsing: $prd_path"
    return 0
}
```

### Validate PRD Frontmatter Structure
```bash
# Comprehensive frontmatter validation
validate_prd_frontmatter() {
    local prd_path="$1"
    
    # Check if file starts with YAML frontmatter
    if ! head -1 "$prd_path" | grep -q "^---$"; then
        echo "❌ Missing YAML frontmatter delimiter in: $prd_path"
        echo "💡 PRD must start with '---'"
        return 1
    fi
    
    # Extract frontmatter
    local frontmatter_end=$(grep -n "^---$" "$prd_path" | sed -n '2p' | cut -d: -f1)
    if [[ -z "$frontmatter_end" ]]; then
        echo "❌ Missing closing YAML frontmatter delimiter in: $prd_path"
        echo "💡 PRD frontmatter must end with '---'"
        return 1
    fi
    
    # Validate required fields
    local required_fields=("name" "status" "created" "version")
    local frontmatter=$(sed -n "2,$((frontmatter_end-1))p" "$prd_path")
    
    for field in "${required_fields[@]}"; do
        if ! echo "$frontmatter" | grep -q "^${field}:"; then
            echo "❌ Missing required field '$field' in: $prd_path"
            echo "💡 Required fields: ${required_fields[*]}"
            return 1
        fi
    done
    
    # Validate field formats
    local name_value=$(echo "$frontmatter" | grep "^name:" | cut -d: -f2- | xargs)
    if [[ -z "$name_value" || "$name_value" == "\"\"" ]]; then
        echo "❌ Empty name field in: $prd_path"
        return 1
    fi
    
    local status_value=$(echo "$frontmatter" | grep "^status:" | cut -d: -f2- | xargs)
    local valid_statuses=("draft" "review" "approved" "implemented")
    if [[ ! " ${valid_statuses[*]} " =~ " ${status_value//\"/} " ]]; then
        echo "❌ Invalid status '$status_value' in: $prd_path"
        echo "💡 Valid statuses: ${valid_statuses[*]}"
        return 1
    fi
    
    echo "✅ PRD frontmatter validated: $prd_path"
    return 0
}
```

### Validate PRD Content Structure
```bash
# Validate PRD has required content sections
validate_prd_content() {
    local prd_path="$1"
    
    local required_sections=("Problem Statement" "Solution Overview" "User Stories")
    local content=$(cat "$prd_path")
    
    for section in "${required_sections[@]}"; do
        if ! echo "$content" | grep -q "## $section"; then
            echo "❌ Missing required section '## $section' in: $prd_path"
            echo "💡 Required sections: ${required_sections[*]}"
            return 1
        fi
    done
    
    # Check for user stories format
    if ! echo "$content" | grep -q "**As a**"; then
        echo "❌ No user stories found in: $prd_path"
        echo "💡 User stories should use format: **As a** ... **I want** ... **So that** ..."
        return 1
    fi
    
    echo "✅ PRD content structure validated: $prd_path"
    return 0
}
```

### Check Epic Generation Prerequisites
```bash
# Validate epic generation won't conflict with existing epics
validate_epic_prerequisites() {
    local prd_name="$1"
    local epic_dir=".cccc/epics/$prd_name"
    
    # Check if epic directory already exists
    if [[ -d "$epic_dir" ]]; then
        echo "⚠️ Epic directory already exists: $epic_dir"
        read -p "Overwrite existing epic? (yes/no): " confirm
        if [[ "$confirm" != "yes" ]]; then
            echo "❌ Epic generation cancelled"
            return 1
        fi
        echo "🔄 Will overwrite existing epic directory"
    fi
    
    # Ensure epics directory exists
    if [[ ! -d ".cccc/epics" ]]; then
        echo "📁 Creating epics directory"
        mkdir -p ".cccc/epics" || {
            echo "❌ Failed to create epics directory"
            return 1
        }
    fi
    
    echo "✅ Epic generation prerequisites validated"
    return 0
}
```
```

## Acceptance Criteria
- [ ] Comprehensive PRD existence and readability validation
- [ ] YAML frontmatter structure validation with specific error messages
- [ ] Content structure validation for required sections
- [ ] Epic generation prerequisite checking
- [ ] Clear error messages with helpful suggestions
- [ ] Proper exit codes for all validation functions
- [ ] Integration with existing parse command flow

## Dependencies
- Issue #002.1: Template structure must be finalized first

## Definition of Done
- [ ] Code implemented according to implementation sketch
- [ ] All acceptance criteria met
- [ ] Validation logic follows CCCC patterns and standards
- [ ] Enhanced error handling and user feedback
- [ ] Ready for error handling enhancements (Issue #004.3)\n\n---\nDepends on #37

## Comments Processing Summary
2025-08-28T11:37:22Z: Updated from platform

### Structured Updates Applied:


**jeunesse.paulien** (2025-08-28T04:42:33.335Z):
mentioned in issue #45


---
*Last updated from platform: 2025-08-28T11:37:22Z*
